<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in - Comet Accounts</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root { --background-color: #0c0c14; --text-color: #e0e0e0; --accent-color: #7e7eff; --subtle-color: #555; --error-color: #ff8a80; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .auth-container { width: 100%; max-width: 380px; text-align: center; padding: 20px; }
        .logo { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; letter-spacing: 1px; color: #fff; }
        .logo span { color: var(--accent-color); }
        h1 { font-size: 1.5rem; font-weight: 500; margin-bottom: 8px; }
        p { color: #aaa; margin-bottom: 40px; }
        .input-group { position: relative; margin-bottom: 30px; }
        .input-field { width: 100%; padding: 10px 0; background-color: transparent; border: none; border-bottom: 1px solid var(--subtle-color); color: #fff; font-size: 1.1rem; transition: border-color 0.3s; }
        .input-field:focus { outline: none; border-bottom-color: var(--accent-color); }
        .user-display { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border: 1px solid var(--subtle-color); border-radius: 20px; margin-bottom: 30px; font-size: 0.9rem; cursor: pointer; }
        .user-display:hover { background-color: rgba(255,255,255,0.05); }
        .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        .link-btn { background: none; border: none; color: var(--accent-color); font-weight: 500; cursor: pointer; font-size: 0.9rem; padding: 0; font-family: 'Inter', sans-serif; }
        .primary-btn { background-color: var(--accent-color); color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; font-family: 'Inter', sans-serif; }
        .primary-btn:hover { background-color: #6a6aff; }
        .error-message { color: var(--error-color); font-size: 0.85rem; text-align: left; margin-top: -20px; margin-bottom: 20px; display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">C<span>o</span>met</div>
        <h1 id="header-title">Sign in</h1>
        <p id="header-subtitle">to continue your journey</p>
        <form id="authForm" novalidate>
            <div id="email-step">
                <div class="input-group">
                    <input type="email" id="cometId" class="input-field" placeholder="Comet ID (email)" required>
                </div>
                <div id="email-error" class="error-message">Couldn't find your Comet Account</div>
                <div class="actions">
                    <a href="2.html" class="link-btn">Create account</a>
                    <button type="button" id="nextBtn" class="primary-btn">Next</button>
                </div>
            </div>
            <div id="password-step" class="hidden">
                 <div id="userDisplay" class="user-display" onclick="goBackToEmailStep()"></div>
                <div class="input-group">
                    <input type="password" id="password" class="input-field" placeholder="Enter your password" required>
                </div>
                <div id="password-error" class="error-message">Wrong password. Try again.</div>
                <div class="actions">
                    <button type="button" class="link-btn">Forgot password?</button>
                    <button type="submit" id="signInBtn" class="primary-btn">Sign In</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBDHgR4VKaa-c5OcfGDhaLfVlDBkRRWd8k",
            authDomain: "commet-accounts.firebaseapp.com",
            projectId: "commet-accounts",
            storageBucket: "commet-accounts.appspot.com",
            messagingSenderId: "35074463743",
            appId: "1:35074463743:web:e11289b56b6fa845e879ca"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOM Elements
        const emailStep = document.getElementById('email-step'), passwordStep = document.getElementById('password-step');
        const cometIdInput = document.getElementById('cometId'), passwordInput = document.getElementById('password');
        const nextBtn = document.getElementById('nextBtn'), authForm = document.getElementById('authForm');
        const userDisplay = document.getElementById('userDisplay');
        const emailError = document.getElementById('email-error'), passwordError = document.getElementById('password-error');
        const headerTitle = document.getElementById('header-title'), headerSubtitle = document.getElementById('header-subtitle');

        let userDocument = null; // To store user data between steps

        function goBackToEmailStep() {
            passwordStep.classList.add('hidden');
            emailStep.classList.remove('hidden');
            headerTitle.textContent = "Sign in";
            headerSubtitle.style.display = 'block';
            passwordInput.value = '';
            passwordError.style.display = 'none';
        }

        nextBtn.addEventListener('click', async () => {
            const email = cometIdInput.value;
            if (!email) {
                emailError.textContent = "Please enter your Comet ID";
                emailError.style.display = 'block'; return;
            }
            emailError.style.display = 'none';

            try {
                // NEW: Check Firestore to see if a user with this email exists
                const userQuery = await db.collection('users').where('cometId', '==', email).limit(1).get();
                if (!userQuery.empty) {
                    userDocument = userQuery.docs[0]; // Store the document for the next step
                    emailStep.classList.add('hidden');
                    passwordStep.classList.remove('hidden');
                    userDisplay.innerHTML = `${email} &#9662;`;
                    headerTitle.textContent = "Welcome";
                    headerSubtitle.style.display = 'none';
                    passwordInput.focus();
                } else {
                    emailError.textContent = "Couldn't find your Comet Account";
                    emailError.style.display = 'block';
                }
            } catch (error) {
                console.error("Error checking user:", error);
                emailError.textContent = "An error occurred. Please try again.";
                emailError.style.display = 'block';
            }
        });

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = passwordInput.value;
            passwordError.style.display = 'none';

            if (!userDocument || !password) {
                passwordError.textContent = "An error occurred. Please try again.";
                passwordError.style.display = 'block'; return;
            }
            
            // NEW: Manually compare the entered password with the one from Firestore
            const storedPassword = userDocument.data().password;
            if (password === storedPassword) {
                // SUCCESS: Passwords match
                // NEW: Store the user's Firestore Document ID in localStorage to manage session
                localStorage.setItem('cometUserDocId', userDocument.id);
                window.location.href = '3.html';
            } else {
                // FAIL: Passwords do not match
                passwordError.textContent = "Wrong password. Try again.";
                passwordError.style.display = 'block';
            }
        });
    </script>
</body>
</html>
