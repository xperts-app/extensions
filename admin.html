<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Attendance Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        h1, h2 {
            color: #1a237e;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 1.4em;
            border-bottom: none;
            text-align: left;
            margin-bottom: 15px;
            padding-bottom: 0;
        }
        .date-selector, .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #e8eaf6;
            border-radius: 8px;
        }
        .date-selector label, .actions-bar p { margin: 0; }
        .date-selector input[type="date"] {
            padding: 8px; border-radius: 6px; border: 1px solid #c5cae9;
            font-family: 'Poppins', sans-serif;
        }
        .action-btn {
            background-color: #3949ab; color: white; padding: 10px 20px;
            border: none; border-radius: 6px; cursor: pointer;
            font-weight: 500; transition: background-color 0.3s ease; text-decoration: none;
        }
        .action-btn:hover { background-color: #1a237e; }
        .teacher-list { list-style-type: none; padding: 0; }
        .teacher-card {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px;
            margin-bottom: 10px; transition: box-shadow 0.2s ease-in-out, border-left 0.3s;
            border-left: 5px solid #ccc; /* Default */
        }
        .teacher-card.status-Present { border-left-color: #4caf50; }
        .teacher-card.status-Absent { border-left-color: #f44336; }
        .teacher-card.status-PL { border-left-color: #2196f3; }
        
        .teacher-info { display: flex; align-items: center; gap: 15px; }
        .teacher-name { font-weight: 600; font-size: 1.1em; }
        .teacher-status {
            padding: 4px 12px; border-radius: 15px; color: white;
            font-weight: 500; font-size: 0.9em;
        }
        .status-Present { background-color: #4caf50; }
        .status-Absent { background-color: #f44336; }
        .status-PL { background-color: #2196f3; }
        .status-NotMarked { background-color: #9e9e9e; }
        
        .attendance-actions button {
            margin-left: 8px; padding: 8px 15px; border: 1px solid #ccc;
            border-radius: 20px; cursor: pointer; font-weight: 500;
            background-color: #fff; transition: all 0.2s ease;
        }
        .attendance-actions button:hover { transform: translateY(-2px); }
        .btn-present:hover { background-color: #4caf50; color: white; border-color: #4caf50;}
        .btn-absent:hover { background-color: #f44336; color: white; border-color: #f44336;}
        .btn-pl:hover { background-color: #2196f3; color: white; border-color: #2196f3;}
        
        /* New styles for the absent list panel */
        .absent-panel {
            margin-top: 40px;
            background-color: #fff3f3;
            border: 1px solid #ffcdd2;
            border-radius: 12px;
            padding: 20px;
        }
        .absent-panel h2 {
            color: #c62828;
        }
        .absent-teacher-list {
            list-style-type: none;
            padding: 0;
        }
        .absent-teacher-list li {
            padding: 10px;
            background-color: #ffebee;
            border-radius: 6px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        #no-absent-message {
            color: #555;
            font-style: italic;
        }
        .status-message {
            text-align: center; padding: 10px; border-radius: 5px;
            margin-top: 10px; visibility: hidden; opacity: 0; transition: all 0.5s ease;
        }
        .status-message.show { visibility: visible; opacity: 1; }
        .status-message.success { background-color: #d4edda; color: #155724; }
        .status-message.error { background-color: #f8d7da; color: #721c24; }
        .status-message.info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin Attendance Panel</h1>
        <div class="date-selector">
            <div>
                <label for="attendance-date">Attendance Date:</label>
                <input type="date" id="attendance-date" readonly>
            </div>
            <a href="./view_attendance.html" class="action-btn">View All Records</a>
        </div>
        <div class="actions-bar">
             <p>Auto-tracking runs on page load. Click to re-run.</p>
             <button class="action-btn" onclick="autoTrackAttendance(true)">
                &#128205; Re-run Auto Track
            </button>
        </div>
        <div id="teacher-list-container">
            <h2>All Teachers</h2>
            <ul id="teacher-list" class="teacher-list"></ul>
            <p id="loading-message">Initializing panel...</p>
        </div>
        <div id="status-message" class="status-message"></div>
    </div>

    <!-- New Absent Teachers Panel -->
    <div class="container absent-panel">
        <h2>Absent Teachers Today</h2>
        <div id="absent-list-container">
            <ul id="absent-teacher-list" class="absent-teacher-list"></ul>
            <p id="no-absent-message">All teachers are accounted for.</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyD-ers6CRuH8bCFomXJHuLxPWff-Xa4ZVk",
          authDomain: "xperts-data.firebaseapp.com",
          projectId: "xperts-data",
          storageBucket: "xperts-data.firebasestorage.app",
          messagingSenderId: "934675149024",
          appId: "1:934675149024:web:23486a5f38f65f103ce085",
          measurementId: "G-6TS06NTDZQ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const teacherListEl = document.getElementById('teacher-list');
        const loadingMessageEl = document.getElementById('loading-message');
        const attendanceDateEl = document.getElementById('attendance-date');
        const statusMessageEl = document.getElementById('status-message');
        const absentListEl = document.getElementById('absent-teacher-list');
        const noAbsentMessageEl = document.getElementById('no-absent-message');

        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        async function initializePanel() {
            attendanceDateEl.value = getTodayDateString();
            loadingMessageEl.textContent = 'Fetching teachers and attendance data...';
            const [teachersSnapshot, attendanceDoc] = await Promise.all([
                db.collection('users').where('role', '==', 'Teacher').get(),
                db.collection('attendance').doc(getTodayDateString()).get()
            ]);
            
            const allTeachers = new Map();
            teachersSnapshot.forEach(doc => allTeachers.set(doc.id, doc.data()));
            const attendanceData = attendanceDoc.exists ? attendanceDoc.data() : {};
            
            loadingMessageEl.style.display = 'none';
            teacherListEl.innerHTML = '';

            allTeachers.forEach((teacher, teacherId) => {
                const status = attendanceData[teacherId]?.status || 'NotMarked';
                const card = document.createElement('li');
                card.className = `teacher-card status-${status}`;
                card.id = `teacher-card-${teacherId}`;
                card.innerHTML = `
                    <div class="teacher-info">
                        <span id="status-badge-${teacherId}" class="teacher-status status-${status}">${status.replace('NotMarked', 'Not Marked')}</span>
                        <span class="teacher-name">${teacher.fullName}</span>
                    </div>
                    <div class="attendance-actions">
                        <button class="btn-present" onclick="markAttendance('${teacherId}', 'Present')">Present</button>
                        <button class="btn-absent" onclick="markAttendance('${teacherId}', 'Absent')">Absent</button>
                        <button class="btn-pl" onclick="markAttendance('${teacherId}', 'PL')">Paid Leave</button>
                    </div>`;
                teacherListEl.appendChild(card);
            });
            
            updateAbsentList();
            await autoTrackAttendance(false);
        }
        
        async function markAttendance(teacherId, status) {
            const attendanceRef = db.collection('attendance').doc(getTodayDateString());
            try {
                await attendanceRef.set({
                    [teacherId]: { status: status, timestamp: firebase.firestore.FieldValue.serverTimestamp() }
                }, { merge: true });

                const cardEl = document.getElementById(`teacher-card-${teacherId}`);
                const statusBadgeEl = document.getElementById(`status-badge-${teacherId}`);
                if (cardEl && statusBadgeEl) {
                    cardEl.className = `teacher-card status-${status}`;
                    statusBadgeEl.className = `teacher-status status-${status}`;
                    statusBadgeEl.textContent = status;
                }
                
                showStatus(`Marked ${status} for teacher ${teacherId.substring(0,6)}...`, 'success');
                updateAbsentList(); // Refresh the absent list after every change
            } catch (error) {
                console.error("Error marking attendance:", error);
                showStatus('Failed to mark attendance. See console.', 'error');
            }
        }

        function updateAbsentList() {
            absentListEl.innerHTML = '';
            const absentCards = document.querySelectorAll('.teacher-card.status-Absent');
            
            if (absentCards.length === 0) {
                noAbsentMessageEl.style.display = 'block';
            } else {
                noAbsentMessageEl.style.display = 'none';
                absentCards.forEach(card => {
                    const name = card.querySelector('.teacher-name').textContent;
                    const listItem = document.createElement('li');
                    listItem.textContent = name;
                    absentListEl.appendChild(listItem);
                });
            }
        }

        async function autoTrackAttendance(manualRun = false) {
            if (manualRun) showStatus('Starting auto-tracking...', 'info');
            
            const TARGET_LAT = 24.5997154, TARGET_LON = 76.1666185, RADIUS_METERS = 5 * 0.3048;
            const todayStart = new Date(getTodayDateString());
            const tomorrowStart = new Date(todayStart);
            tomorrowStart.setDate(tomorrowStart.getDate() + 1);

            const locationsSnapshot = await db.collection('teacher_locations')
                .where('timestamp', '>=', todayStart)
                .where('timestamp', '<', tomorrowStart)
                .get();

            const locationsMap = new Map();
            locationsSnapshot.forEach(doc => {
                const data = doc.data();
                locationsMap.set(data.teacherId, { lat: data.latitude, lon: data.longitude });
            });
            
            let processedCount = 0;
            const unmarkedCards = document.querySelectorAll('.teacher-card.status-NotMarked');
            
            for (const card of unmarkedCards) {
                const teacherId = card.id.replace('teacher-card-', '');
                const teacherLocation = locationsMap.get(teacherId);
                let status = 'Absent';
                if (teacherLocation) {
                    const distance = calculateDistance(TARGET_LAT, TARGET_LON, teacherLocation.lat, teacherLocation.lon);
                    if (distance <= RADIUS_METERS) status = 'Present';
                }
                await markAttendance(teacherId, status);
                processedCount++;
            }
            
            if (manualRun || processedCount > 0) {
                showStatus(`Auto-tracking complete. Processed ${processedCount} unmarked teachers.`, 'success');
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180, φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180, Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2)**2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2)**2;
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function showStatus(message, type) {
            statusMessageEl.textContent = message;
            statusMessageEl.className = `status-message ${type} show`;
            setTimeout(() => { statusMessageEl.classList.remove('show'); }, 4000);
        }

        document.addEventListener('DOMContentLoaded', initializePanel);
    </script>
</body>
</html>
